<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DriveSafe — Hệ thống giám sát lái xe</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Exo+2:wght@300;400;600&display=swap');
  :root {
    --bg:#020c14;--panel:#071828;--border:#0a3d62;
    --accent:#00d4ff;--accent2:#00ff88;--warn:#ff6b35;--danger:#ff1744;
    --text:#c8e6f5;--dim:#3a6d8a;--grid:rgba(0,212,255,0.04);
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:'Exo 2',sans-serif;min-height:100vh;overflow-x:hidden}
  body::before{content:'';position:fixed;inset:0;
    background-image:linear-gradient(var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);
    background-size:40px 40px;pointer-events:none;z-index:0}
  header{position:relative;z-index:10;padding:16px 28px;display:flex;align-items:center;justify-content:space-between;
    border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(0,212,255,0.06) 0%,transparent 100%)}
  .logo{font-family:'Orbitron',monospace;font-size:1.4rem;font-weight:900;color:var(--accent);letter-spacing:.15em;text-shadow:0 0 20px rgba(0,212,255,0.5)}
  .logo span{color:var(--accent2)}
  .header-status{font-family:'Share Tech Mono',monospace;font-size:.7rem;color:var(--dim);text-align:right;line-height:1.8}
  .main{position:relative;z-index:1;display:grid;grid-template-columns:1fr 320px;gap:16px;padding:16px 20px;max-width:1300px;margin:0 auto}
  .camera-panel{background:var(--panel);border:1px solid var(--border);border-radius:4px;overflow:hidden}
  .camera-wrap{position:relative;aspect-ratio:4/3;background:#000;overflow:hidden}
  #videoEl{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);display:block}
  #canvasEl{position:absolute;inset:0;width:100%;height:100%;transform:scaleX(-1);pointer-events:none}
  .cam-overlay{position:absolute;inset:0;pointer-events:none;border:2px solid var(--accent);box-shadow:inset 0 0 40px rgba(0,212,255,0.1)}
  .cam-overlay::before{content:'';position:absolute;top:-1px;left:-1px;width:20px;height:20px;border-top:3px solid var(--accent);border-left:3px solid var(--accent)}
  .cam-overlay::after{content:'';position:absolute;bottom:-1px;right:-1px;width:20px;height:20px;border-bottom:3px solid var(--accent);border-right:3px solid var(--accent)}
  .scan-line{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(0,212,255,0.6),transparent);animation:scan 3s linear infinite;pointer-events:none}
  @keyframes scan{0%{top:0;opacity:1}100%{top:100%;opacity:0}}
  .cam-label{position:absolute;top:10px;left:10px;font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--accent);background:rgba(2,12,20,0.85);padding:3px 8px;border:1px solid rgba(0,212,255,0.3)}
  .fps-label{position:absolute;top:10px;right:10px;font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);background:rgba(2,12,20,0.85);padding:3px 8px;border:1px solid var(--border)}
  /* Camera placeholder */
  .cam-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;background:rgba(2,12,20,0.95)}
  .cam-placeholder svg{opacity:.3}
  .cam-placeholder p{font-family:'Share Tech Mono',monospace;font-size:.7rem;color:var(--dim);text-align:center;line-height:1.7}
  .alert-banner{padding:0 20px;min-height:50px;display:flex;align-items:center;justify-content:center;gap:10px;
    font-family:'Orbitron',monospace;font-size:.8rem;letter-spacing:.1em;font-weight:700;transition:all .3s;border-top:1px solid var(--border)}
  .alert-banner.safe{color:var(--accent2);background:rgba(0,255,136,0.05)}
  .alert-banner.warn{color:var(--warn);background:rgba(255,107,53,0.08);animation:pw 1s infinite}
  .alert-banner.danger{color:var(--danger);background:rgba(255,23,68,0.1);animation:pd .5s infinite}
  @keyframes pw{0%,100%{opacity:1}50%{opacity:.6}}
  @keyframes pd{0%,100%{opacity:1}50%{opacity:.4}}
  .alert-dot{width:9px;height:9px;border-radius:50%;background:currentColor;box-shadow:0 0 8px currentColor}
  .controls{display:flex;gap:10px;padding:14px 16px;border-top:1px solid var(--border)}
  .btn{flex:1;padding:11px 16px;font-family:'Orbitron',monospace;font-size:.7rem;font-weight:700;letter-spacing:.1em;border:none;cursor:pointer;text-transform:uppercase;transition:all .2s;clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%)}
  .btn-start{background:linear-gradient(135deg,#004d40,#00897b);color:#a7ffeb;box-shadow:0 0 20px rgba(0,137,123,.3)}
  .btn-start:hover{background:linear-gradient(135deg,#00695c,#00acc1)}
  .btn-stop{background:linear-gradient(135deg,#4a0000,#b71c1c);color:#ffcdd2;box-shadow:0 0 20px rgba(183,28,28,.3)}
  .btn:disabled{opacity:.35;cursor:not-allowed}
  .right-panel{display:flex;flex-direction:column;gap:12px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:4px;overflow:hidden}
  .card-header{padding:9px 14px;background:rgba(0,212,255,0.04);border-bottom:1px solid var(--border);
    font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);letter-spacing:.15em;text-transform:uppercase;display:flex;align-items:center;gap:6px}
  .card-header::before{content:'//';color:var(--accent);font-size:.65rem}
  .metrics{padding:10px 14px;display:flex;flex-direction:column;gap:9px}
  .metric-row{display:flex;align-items:center;justify-content:space-between}
  .metric-label{font-size:.7rem;color:var(--dim);font-family:'Share Tech Mono',monospace}
  .metric-value{font-family:'Orbitron',monospace;font-size:.8rem;font-weight:700}
  .bar-wrap{width:100%;margin-top:4px;height:3px;background:rgba(0,212,255,0.1);border-radius:2px;overflow:hidden}
  .bar{height:100%;border-radius:2px;transition:width .2s,background .3s;background:var(--accent2)}
  .badge{font-family:'Share Tech Mono',monospace;font-size:.65rem;padding:2px 8px;border-radius:2px;letter-spacing:.06em}
  .badge.open{background:rgba(0,255,136,0.15);color:var(--accent2);border:1px solid rgba(0,255,136,0.3)}
  .badge.closed{background:rgba(255,107,53,0.15);color:var(--warn);border:1px solid rgba(255,107,53,0.3)}
  .badge.normal{background:rgba(0,212,255,0.1);color:var(--accent);border:1px solid rgba(0,212,255,0.2)}
  .badge.yawn{background:rgba(255,107,53,0.15);color:var(--warn);border:1px solid rgba(255,107,53,0.3)}
  .badge.center{background:rgba(0,255,136,0.15);color:var(--accent2);border:1px solid rgba(0,255,136,0.3)}
  .badge.away{background:rgba(255,23,68,0.15);color:var(--danger);border:1px solid rgba(255,23,68,0.3)}
  .gauge-section{padding:12px 14px 14px}
  .gauge-track{width:100%;height:7px;background:rgba(0,212,255,0.08);border-radius:4px;position:relative;margin-bottom:4px}
  .gauge-zone{position:absolute;top:0;bottom:0;background:rgba(0,255,136,0.15);border:1px solid rgba(0,255,136,0.25);border-radius:4px;left:35%;width:30%}
  .gauge-cursor{position:absolute;top:-5px;width:16px;height:16px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent);transform:translateX(-50%);transition:left .15s,background .3s;left:50%}
  .gauge-labels{display:flex;justify-content:space-between;font-family:'Share Tech Mono',monospace;font-size:.55rem;color:var(--dim);margin-bottom:8px}
  .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border)}
  .stat-cell{background:var(--panel);padding:10px 8px;text-align:center}
  .stat-num{font-family:'Orbitron',monospace;font-size:1.3rem;font-weight:900;color:var(--accent);line-height:1}
  .stat-label{font-family:'Share Tech Mono',monospace;font-size:.5rem;color:var(--dim);margin-top:3px;text-transform:uppercase}
  .chart-wrap{padding:10px 14px 14px}
  #tripChart{max-height:120px}
  .log-body{padding:8px 14px;max-height:140px;overflow-y:auto;display:flex;flex-direction:column;gap:3px}
  .log-body::-webkit-scrollbar{width:3px}
  .log-body::-webkit-scrollbar-thumb{background:var(--border)}
  .log-entry{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);padding:2px 7px;border-left:2px solid var(--border);line-height:1.4}
  .log-entry.warn{color:var(--warn);border-color:var(--warn)}
  .log-entry.danger{color:var(--danger);border-color:var(--danger)}
  .log-entry.info{color:var(--accent);border-color:var(--accent)}
  /* Error box */
  .err-box{margin:12px 16px;padding:10px 14px;background:rgba(255,23,68,0.08);border:1px solid rgba(255,23,68,0.3);border-radius:3px;font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--danger);line-height:1.6;display:none}
  @media(max-width:860px){.main{grid-template-columns:1fr}.right-panel{display:grid;grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.right-panel{grid-template-columns:1fr}.main{padding:10px}}
</style>
</head>
<body>

<header>
  <div class="logo">DRIVE<span>SAFE</span></div>
  <div class="header-status">
    <div id="sysTime">--:--:--</div>
    <div id="sysStatus" style="color:var(--dim)">CHỜ</div>
  </div>
</header>

<div class="main">
  <!-- Camera Panel -->
  <div class="camera-panel">
    <div class="camera-wrap">
      <video id="videoEl" playsinline autoplay muted></video>
      <canvas id="canvasEl"></canvas>
      <div class="cam-overlay"><div class="scan-line"></div></div>
      <div class="cam-label">CAM-01 // TRỰC TIẾP</div>
      <div class="fps-label" id="fpsLabel">0 FPS</div>
      <!-- Placeholder khi chưa bắt đầu -->
      <div class="cam-placeholder" id="camPlaceholder">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1">
          <path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/>
        </svg>
        <p>Nhấn <strong style="color:var(--accent)">BẮT ĐẦU GIÁM SÁT</strong> để<br>kích hoạt camera và phân tích khuôn mặt</p>
      </div>
    </div>
    <!-- Error box -->
    <div class="err-box" id="errBox"></div>

    <div class="alert-banner safe" id="alertBanner">
      <div class="alert-dot"></div>
      <span id="alertText">HỆ THỐNG SẴN SÀNG</span>
    </div>
    <div class="controls">
      <button class="btn btn-start" id="btnStart" onclick="startMonitor()">▶ BẮT ĐẦU GIÁM SÁT</button>
      <button class="btn btn-stop"  id="btnStop"  onclick="stopMonitor()" disabled>■ DỪNG</button>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="right-panel">
    <!-- Eye & Mouth -->
    <div class="card">
      <div class="card-header">Trạng thái khuôn mặt</div>
      <div class="metrics">
        <div>
          <div class="metric-row">
            <span class="metric-label">MẮT</span>
            <span class="badge open" id="eyeStatus">MỞ</span>
          </div>
          <div class="metric-row" style="margin-top:5px">
            <span class="metric-label">Chỉ số EAR</span>
            <span class="metric-value" id="earValue" style="color:var(--accent2)">—</span>
          </div>
          <div class="bar-wrap"><div class="bar" id="earBar" style="width:0%"></div></div>
        </div>
        <div>
          <div class="metric-row">
            <span class="metric-label">MIỆNG / NGÁP</span>
            <span class="badge normal" id="mouthStatus">BÌNH THƯỜNG</span>
          </div>
          <div class="metric-row" style="margin-top:5px">
            <span class="metric-label">Chỉ số MAR</span>
            <span class="metric-value" id="marValue" style="color:var(--accent2)">—</span>
          </div>
          <div class="bar-wrap"><div class="bar" id="marBar" style="width:0%;background:var(--accent)"></div></div>
        </div>
      </div>
    </div>

    <!-- Head Pose -->
    <div class="card">
      <div class="card-header">Hướng nhìn</div>
      <div class="metric-row" style="padding:10px 14px 4px">
        <span class="metric-label">TRẠNG THÁI</span>
        <span class="badge center" id="poseStatus">THẲNG</span>
      </div>
      <div class="gauge-section">
        <div class="gauge-track">
          <div class="gauge-zone"></div>
          <div class="gauge-cursor" id="gaugeCursor"></div>
        </div>
        <div class="gauge-labels"><span>TRÁI 60°</span><span>TRUNG TÂM</span><span>PHẢI 60°</span></div>
        <div class="metric-row">
          <span class="metric-label">GÓC NGANG</span>
          <span class="metric-value" id="yawValue" style="color:var(--accent)">0°</span>
        </div>
        <div class="metric-row" style="margin-top:4px">
          <span class="metric-label">GÓC DỌC</span>
          <span class="metric-value" id="pitchValue" style="color:var(--accent)">0°</span>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="card">
      <div class="card-header">Thống kê chuyến đi</div>
      <div class="stats-grid">
        <div class="stat-cell"><div class="stat-num" id="statDrowsy">0</div><div class="stat-label">Buồn ngủ</div></div>
        <div class="stat-cell"><div class="stat-num" id="statYawn">0</div><div class="stat-label">Ngáp</div></div>
        <div class="stat-cell"><div class="stat-num" id="statDistract">0</div><div class="stat-label">Lơ đãng</div></div>
      </div>
      <div class="chart-wrap"><canvas id="tripChart"></canvas></div>
    </div>

    <!-- Log -->
    <div class="card">
      <div class="card-header">Nhật ký sự kiện</div>
      <div class="log-body" id="logBody">
        <div class="log-entry info">HỆ THỐNG KHỞI ĐỘNG</div>
      </div>
    </div>
  </div>
</div>

<!-- MediaPipe qua CDN jsDelivr (ổn định hơn) -->
<script>
// ---- Load MediaPipe động để tránh lỗi CORS/CDN ----
function loadScript(src) {
  return new Promise((res, rej) => {
    const s = document.createElement('script');
    s.src = src; s.crossOrigin = 'anonymous';
    s.onload = res; s.onerror = () => rej(new Error('Không tải được: ' + src));
    document.head.appendChild(s);
  });
}

// ================================================================
// CONFIG
// ================================================================
const EAR_THRESHOLD   = 0.20;
const EAR_CONSEC_SEC  = 2.0;
const MAR_THRESHOLD   = 0.55;
const MAR_CONSEC_SEC  = 1.5;
const YAW_THRESHOLD   = 30;
const PITCH_THRESHOLD = 25;
const POSE_CONSEC_SEC = 3.0;

// ================================================================
// State
// ================================================================
let isRunning = false, faceMesh = null, camera = null, ctx2d = null;
let earClosedStart = null, marOpenStart = null, poseAbnStart = null;
let lastFpsTime = performance.now(), frameCount = 0;
let stats = { drowsy:0, yawn:0, distract:0 };
let chartLabels = [], chartData = { drowsy:[], yawn:[], distract:[] };
let alertCooldown = {};
let tripChart = null, chartMinute = -1;
let mediapipeReady = false;

// ================================================================
// Audio
// ================================================================
let audioCtx = null;
function getAC() { if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
function beep(freq=880, dur=0.3, vol=0.4, type='sine') {
  try {
    const ac=getAC(), o=ac.createOscillator(), g=ac.createGain();
    o.connect(g); g.connect(ac.destination);
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(vol,ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+dur);
    o.start(); o.stop(ac.currentTime+dur);
  } catch(e){}
}
function alertSound(type) {
  const now=Date.now();
  if (alertCooldown[type] && now-alertCooldown[type]<5000) return;
  alertCooldown[type]=now;
  if (type==='drowsy')  { beep(440,.4,.5,'sawtooth'); setTimeout(()=>beep(440,.4,.5,'sawtooth'),500); }
  if (type==='yawn')    { beep(600,.5,.3,'sine'); }
  if (type==='distract'){ beep(880,.2,.4,'square'); setTimeout(()=>beep(700,.2,.4,'square'),250); }
}

// ================================================================
// Geometry helpers
// ================================================================
function d2(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }
function ear(lm,idx) {
  const p=idx.map(i=>lm[i]);
  return (d2(p[1],p[5])+d2(p[2],p[4]))/(2*d2(p[0],p[3]));
}
const LE=[33,160,158,133,153,144], RE=[362,385,387,263,373,380];
function mar(lm){ return d2(lm[13],lm[14])/d2(lm[78],lm[308]); }
function headPose(lm) {
  const lEye=lm[33],rEye=lm[263],nose=lm[1],forehead=lm[10],chin=lm[152];
  const cx=(lEye.x+rEye.x)/2, ew=d2(lEye,rEye);
  const yaw=Math.atan2(nose.x-cx,ew*0.5)*(180/Math.PI)*2.5;
  const fh=d2(forehead,chin), midY=(forehead.y+chin.y)/2;
  const pitch=-((nose.y-midY)/(fh*0.3))*30;
  return { yaw:Math.max(-60,Math.min(60,yaw)), pitch:Math.max(-45,Math.min(45,pitch)) };
}

// ================================================================
// UI helpers
// ================================================================
function setAlert(level, text) {
  const b=document.getElementById('alertBanner');
  b.className='alert-banner '+level;
  document.getElementById('alertText').textContent=text;
  const el=document.getElementById('sysStatus');
  el.textContent=({safe:'AN TOÀN',warn:'CẢNH BÁO',danger:'NGUY HIỂM'}[level]||level);
  el.style.color=({safe:'var(--accent2)',warn:'var(--warn)',danger:'var(--danger)'}[level]||'var(--dim)');
}
function setErr(msg) {
  const b=document.getElementById('errBox');
  if (msg) { b.style.display='block'; b.textContent='⚠ '+msg; }
  else { b.style.display='none'; b.textContent=''; }
}
function updateEye(v) {
  document.getElementById('earValue').textContent=v.toFixed(3);
  const pct=Math.min(100,v*250);
  const bar=document.getElementById('earBar');
  bar.style.width=pct+'%'; bar.style.background=v<EAR_THRESHOLD?'var(--danger)':'var(--accent2)';
  const bd=document.getElementById('eyeStatus');
  bd.textContent=v<EAR_THRESHOLD?'NHẮM':'MỞ'; bd.className='badge '+(v<EAR_THRESHOLD?'closed':'open');
}
function updateMouth(v) {
  document.getElementById('marValue').textContent=v.toFixed(3);
  const bar=document.getElementById('marBar');
  bar.style.width=Math.min(100,v*100)+'%'; bar.style.background=v>MAR_THRESHOLD?'var(--warn)':'var(--accent)';
  const bd=document.getElementById('mouthStatus');
  bd.textContent=v>MAR_THRESHOLD?'NGÁP!':'BÌNH THƯỜNG'; bd.className='badge '+(v>MAR_THRESHOLD?'yawn':'normal');
}
function updatePose(yaw,pitch) {
  document.getElementById('yawValue').textContent=yaw.toFixed(1)+'°';
  document.getElementById('pitchValue').textContent=pitch.toFixed(1)+'°';
  const pct=((yaw+60)/120)*100;
  const cur=document.getElementById('gaugeCursor');
  cur.style.left=pct+'%';
  const away=Math.abs(yaw)>YAW_THRESHOLD||pitch>PITCH_THRESHOLD;
  cur.style.background=away?'var(--danger)':'var(--accent)';
  cur.style.boxShadow=away?'0 0 10px var(--danger)':'0 0 10px var(--accent)';
  const bd=document.getElementById('poseStatus');
  bd.textContent=away?'LỆCH':'THẲNG'; bd.className='badge '+(away?'away':'center');
}
function addLog(text, type='') {
  const now=new Date().toLocaleTimeString('vi-VN');
  const body=document.getElementById('logBody');
  const div=document.createElement('div');
  div.className='log-entry '+type; div.textContent=`[${now}] ${text}`;
  body.prepend(div);
  while(body.children.length>60) body.removeChild(body.lastChild);
}

// ================================================================
// Chart
// ================================================================
function initChart() {
  const canvas=document.getElementById('tripChart');
  if (tripChart) { tripChart.destroy(); }
  tripChart=new Chart(canvas,{
    type:'bar',
    data:{ labels:chartLabels, datasets:[
      {label:'Buồn ngủ',data:chartData.drowsy,backgroundColor:'rgba(255,23,68,.6)',borderColor:'var(--danger)',borderWidth:1},
      {label:'Ngáp',data:chartData.yawn,backgroundColor:'rgba(255,107,53,.6)',borderColor:'var(--warn)',borderWidth:1},
      {label:'Lơ đãng',data:chartData.distract,backgroundColor:'rgba(0,212,255,.6)',borderColor:'var(--accent)',borderWidth:1},
    ]},
    options:{responsive:true,animation:false,
      plugins:{legend:{labels:{color:'rgba(200,230,245,.6)',font:{size:8,family:'Share Tech Mono'},boxWidth:9}}},
      scales:{
        x:{ticks:{color:'rgba(200,230,245,.4)',font:{size:7}},grid:{color:'rgba(0,212,255,.05)'}},
        y:{ticks:{color:'rgba(200,230,245,.4)',font:{size:7},stepSize:1},grid:{color:'rgba(0,212,255,.05)'},beginAtZero:true}
      }
    }
  });
}
function pushChart(drowsy,yawn,distract) {
  const min=Math.floor(Date.now()/60000);
  if (min!==chartMinute) {
    chartMinute=min;
    const t=new Date().toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
    chartLabels.push(t); chartData.drowsy.push(0); chartData.yawn.push(0); chartData.distract.push(0);
    if (chartLabels.length>10){ chartLabels.shift(); chartData.drowsy.shift(); chartData.yawn.shift(); chartData.distract.shift(); }
  }
  const i=chartData.drowsy.length-1; if(i<0)return;
  if(drowsy)chartData.drowsy[i]++; if(yawn)chartData.yawn[i]++; if(distract)chartData.distract[i]++;
  if(tripChart) tripChart.update('none');
}

// ================================================================
// MediaPipe callback
// ================================================================
function onResults(results) {
  const video=document.getElementById('videoEl');
  const canvas=document.getElementById('canvasEl');
  canvas.width=video.videoWidth||640; canvas.height=video.videoHeight||480;
  if(!ctx2d) ctx2d=canvas.getContext('2d');
  ctx2d.clearRect(0,0,canvas.width,canvas.height);

  // FPS
  frameCount++;
  const now=performance.now();
  if(now-lastFpsTime>=1000){ document.getElementById('fpsLabel').textContent=frameCount+' FPS'; frameCount=0; lastFpsTime=now; }

  if(!results.multiFaceLandmarks||!results.multiFaceLandmarks.length){
    setAlert('warn','KHÔNG PHÁT HIỆN KHUÔN MẶT');
    return;
  }
  const lm=results.multiFaceLandmarks[0];
  const W=canvas.width, H=canvas.height;
  const px=l=>({x:l.x*W,y:l.y*H,z:l.z});
  const slm=lm.map(px);

  // Vẽ viền mắt
  const drawLoop=(idxArr,color)=>{
    ctx2d.strokeStyle=color; ctx2d.lineWidth=1.2; ctx2d.beginPath();
    idxArr.forEach((i,j)=>{ const p=slm[i]; j===0?ctx2d.moveTo(p.x,p.y):ctx2d.lineTo(p.x,p.y); });
    ctx2d.closePath(); ctx2d.stroke();
  };
  drawLoop(LE,'rgba(0,255,136,.7)');
  drawLoop(RE,'rgba(0,255,136,.7)');
  drawLoop([78,95,88,178,87,14,317,402,318,308,415,310,311,312,13,82,81,80,191],'rgba(255,107,53,.5)');

  // Tính chỉ số
  const earVal=(ear(slm,LE)+ear(slm,RE))/2;
  const marVal=mar(slm);
  const {yaw,pitch}=headPose(lm);

  updateEye(earVal); updateMouth(marVal); updatePose(yaw,pitch);

  const ts=performance.now()/1000;
  let level='safe', msg='AN TOÀN — ĐANG THEO DÕI';
  let nDrowsy=false, nYawn=false, nDistract=false;

  // --- Buồn ngủ ---
  if(earVal<EAR_THRESHOLD){
    if(!earClosedStart) earClosedStart=ts;
    const el=ts-earClosedStart;
    if(el>=EAR_CONSEC_SEC){ level='danger'; msg='⚠ BUỒN NGỦ! HÃY DỪNG XE NGHỈ NGƠI!'; nDrowsy=true; alertSound('drowsy'); }
    else if(el>=1){ level='warn'; msg='MẮT ĐANG NHẮM — CHÚ Ý!'; }
  } else earClosedStart=null;

  // --- Ngáp ---
  if(marVal>MAR_THRESHOLD){
    if(!marOpenStart) marOpenStart=ts;
    if(ts-marOpenStart>=MAR_CONSEC_SEC){
      if(level!=='danger') level='warn';
      msg='PHÁT HIỆN NGÁP — NÊN NGHỈ NGƠI!'; nYawn=true; alertSound('yawn');
    }
  } else marOpenStart=null;

  // --- Mất tập trung ---
  const poseAbn=Math.abs(yaw)>YAW_THRESHOLD||pitch>PITCH_THRESHOLD;
  if(poseAbn){
    if(!poseAbnStart) poseAbnStart=ts;
    const el=ts-poseAbnStart;
    const reason=pitch>PITCH_THRESHOLD?'NHÌN XUỐNG (SĐT?)':(yaw>0?'NHÌN SANG PHẢI':'NHÌN SANG TRÁI');
    if(el>=POSE_CONSEC_SEC){ if(level!=='danger') level='warn'; msg=`⚠ MẤT TẬP TRUNG — ${reason}`; nDistract=true; alertSound('distract'); }
    else if(el>=1.5 && level==='safe') msg=`CHÚ Ý ĐẦU GỐI — ${reason}`;
  } else poseAbnStart=null;

  setAlert(level,msg);

  if(nDrowsy)  { stats.drowsy++;   document.getElementById('statDrowsy').textContent=stats.drowsy;   addLog('BUỒN NGỦ phát hiện','danger'); }
  if(nYawn)    { stats.yawn++;     document.getElementById('statYawn').textContent=stats.yawn;       addLog('NGÁP phát hiện','warn'); }
  if(nDistract){ stats.distract++; document.getElementById('statDistract').textContent=stats.distract; addLog('MẤT TẬP TRUNG: '+(pitch>PITCH_THRESHOLD?'Cúi đầu':(yaw>0?'Phải':'Trái')),'warn'); }
  pushChart(nDrowsy,nYawn,nDistract);

  // Dấu chấm mũi
  const nose=slm[1];
  ctx2d.fillStyle=poseAbn?'var(--danger)':'var(--accent)';
  ctx2d.beginPath(); ctx2d.arc(nose.x,nose.y,4,0,Math.PI*2); ctx2d.fill();
}

// ================================================================
// Start / Stop — sử dụng getUserMedia trực tiếp (đơn giản, ổn định)
// ================================================================
let animId=null;

async function startMonitor() {
  document.getElementById('btnStart').disabled=true;
  document.getElementById('btnStop').disabled=false;
  setErr('');
  setAlert('safe','ĐANG KHỞI ĐỘNG...');
  addLog('Đang khởi động camera...','info');

  try {
    getAC(); // unlock audio

    // --- Bước 1: Lấy quyền camera bằng getUserMedia thuần ---
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { width:{ideal:640}, height:{ideal:480}, facingMode:'user' },
      audio: false
    });

    const video=document.getElementById('videoEl');
    video.srcObject=stream;
    await video.play();

    // Ẩn placeholder
    document.getElementById('camPlaceholder').style.display='none';
    addLog('Camera đã mở','info');

    // --- Bước 2: Nạp MediaPipe nếu chưa có ---
    if(!mediapipeReady) {
      setAlert('safe','ĐANG NẠP MÔ HÌNH AI...');
      addLog('Đang tải MediaPipe FaceMesh...','info');
      await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js');
      await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js');
      mediapipeReady=true;
      addLog('Mô hình AI đã sẵn sàng','info');
    }

    // --- Bước 3: Khởi tạo FaceMesh ---
    faceMesh=new FaceMesh({ locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${f}` });
    faceMesh.setOptions({ maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:.5, minTrackingConfidence:.5 });
    faceMesh.onResults(onResults);

    // --- Bước 4: Vòng lặp phân tích từng frame bằng requestAnimationFrame ---
    isRunning=true;
    async function loop() {
      if(!isRunning) return;
      await faceMesh.send({ image: video });
      animId=requestAnimationFrame(loop);
    }
    loop();

    setAlert('safe','AN TOÀN — ĐANG THEO DÕI');
    document.getElementById('sysStatus').textContent='ĐANG CHẠY';
    document.getElementById('sysStatus').style.color='var(--accent2)';
    addLog('Giám sát bắt đầu','info');

  } catch(err) {
    console.error(err);
    document.getElementById('btnStart').disabled=false;
    document.getElementById('btnStop').disabled=true;
    document.getElementById('camPlaceholder').style.display='flex';

    let msg='Lỗi không xác định: '+err.message;
    if(err.name==='NotAllowedError'||err.name==='PermissionDeniedError')
      msg='Quyền camera bị từ chối. Vui lòng cho phép truy cập camera trong cài đặt trình duyệt rồi thử lại.';
    else if(err.name==='NotFoundError'||err.name==='DevicesNotFoundError')
      msg='Không tìm thấy camera. Hãy kiểm tra thiết bị có camera và kết nối lại.';
    else if(err.name==='NotReadableError'||err.name==='TrackStartError')
      msg='Camera đang được ứng dụng khác sử dụng. Vui lòng đóng ứng dụng đó và thử lại.';
    else if(err.name==='OverconstrainedError')
      msg='Camera không hỗ trợ độ phân giải yêu cầu. Thử đổi camera khác.';
    else if(err.message && err.message.includes('tải'))
      msg='Không tải được thư viện AI. Kiểm tra kết nối internet và tải lại trang.';

    setErr(msg);
    setAlert('warn','LỖI KHỞI ĐỘNG');
    addLog('Lỗi: '+msg,'warn');
  }
}

function stopMonitor() {
  isRunning=false;
  if(animId) { cancelAnimationFrame(animId); animId=null; }

  // Tắt camera stream
  const video=document.getElementById('videoEl');
  if(video.srcObject) {
    video.srcObject.getTracks().forEach(t=>t.stop());
    video.srcObject=null;
  }
  if(faceMesh) { faceMesh=null; }

  // Xoá canvas
  const canvas=document.getElementById('canvasEl');
  if(ctx2d) { ctx2d.clearRect(0,0,canvas.width,canvas.height); }

  // Hiện lại placeholder
  document.getElementById('camPlaceholder').style.display='flex';
  document.getElementById('btnStart').disabled=false;
  document.getElementById('btnStop').disabled=true;

  setAlert('safe','ĐÃ DỪNG GIÁM SÁT');
  document.getElementById('sysStatus').textContent='CHỜ';
  document.getElementById('sysStatus').style.color='var(--dim)';
  addLog(`Dừng — Buồn ngủ:${stats.drowsy} Ngáp:${stats.yawn} Lơ đãng:${stats.distract}`,'info');
  earClosedStart=marOpenStart=poseAbnStart=null;
}

// ================================================================
// Clock & init
// ================================================================
setInterval(()=>{ document.getElementById('sysTime').textContent=new Date().toLocaleTimeString('vi-VN'); },1000);
document.getElementById('sysTime').textContent=new Date().toLocaleTimeString('vi-VN');
initChart();
</script>
</body>
</html>
