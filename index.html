<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DriveSafe</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: #0a0a0a;
  color: #fff;
  font-family: 'Segoe UI', Arial, sans-serif;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
/*cap nhap lai 3.0* / 
/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  background: #111;
  border-bottom: 3px solid #f0b000;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}
.logo {
  font-size: 1.6rem;
  font-weight: 900;
  letter-spacing: .06em;
  color: #f0b000;
}
.logo span { color: #fff; }
.authors {
  font-size: .7rem;
  color: #888;
  text-align: center;
  line-height: 1.7;
}
.authors strong { color: #bbb; }
.clock {
  font-size: 1.1rem;
  font-weight: 700;
  color: #f0b000;
  font-variant-numeric: tabular-nums;
  text-align: right;
}
.clock small { display:block; font-size:.6rem; color:#666; font-weight:400; }

/* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
.main {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 280px;
  gap: 12px;
  padding: 12px;
}

/* ‚îÄ‚îÄ CAMERA ‚îÄ‚îÄ */
.cam-card {
  background: #111;
  border: 2px solid #222;
  border-radius: 10px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.cam-wrap {
  position: relative;
  flex: 1;
  background: #000;
  min-height: 300px;
}
video {
  width: 100%; height: 100%;
  object-fit: cover;
  transform: scaleX(-1);
  display: block;
}
canvas {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  transform: scaleX(-1);
  pointer-events: none;
}
.cam-placeholder {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 14px;
  background: #0a0a0a;
  color: #444;
}
.cam-placeholder svg { opacity: .4; }
.cam-placeholder p { font-size: .8rem; color: #555; text-align: center; line-height: 1.6; }
.fps-tag {
  position: absolute; top: 10px; right: 10px;
  background: rgba(0,0,0,.7);
  color: #888;
  font-size: .65rem;
  padding: 3px 8px;
  border-radius: 4px;
}

/* ‚îÄ‚îÄ ALERT BANNER ‚îÄ‚îÄ */
.alert-banner {
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 1rem;
  font-weight: 700;
  letter-spacing: .04em;
  transition: background .3s, color .3s;
}
.alert-dot {
  width: 14px; height: 14px;
  border-radius: 50%;
  background: currentColor;
  flex-shrink: 0;
  box-shadow: 0 0 0 3px rgba(255,255,255,0.15);
}
.alert-banner.safe    { background: #0f2e1a; color: #2ecc71; }
.alert-banner.warn    { background: #2e1e00; color: #f0b000; animation: blink-warn .9s infinite; }
.alert-banner.danger  { background: #2e0000; color: #ff3333; animation: blink-danger .4s infinite; }
@keyframes blink-warn   { 0%,100%{opacity:1} 50%{opacity:.5} }
@keyframes blink-danger { 0%,100%{opacity:1} 50%{opacity:.3} }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btns { display: flex; gap: 10px; padding: 12px; background: #0d0d0d; }
.btn {
  flex: 1; padding: 14px;
  font-size: .85rem; font-weight: 700;
  border: none; border-radius: 8px;
  cursor: pointer; letter-spacing: .05em;
  text-transform: uppercase;
  transition: opacity .2s, transform .1s;
}
.btn:active { transform: scale(.97); }
.btn:disabled { opacity: .3; cursor: not-allowed; }
.btn-start { background: #f0b000; color: #000; }
.btn-start:hover:not(:disabled) { background: #ffc107; }
.btn-stop  { background: #c0392b; color: #fff; }
.btn-stop:hover:not(:disabled)  { background: #e74c3c; }

/* ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ */
.err-box {
  display: none;
  margin: 8px 12px;
  padding: 10px 14px;
  background: #1a0000;
  border-left: 4px solid #ff3333;
  border-radius: 4px;
  font-size: .72rem;
  color: #ff8888;
  line-height: 1.6;
}

/* ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ */
.right { display: flex; flex-direction: column; gap: 10px; }

/* ‚îÄ‚îÄ METRIC CARD ‚îÄ‚îÄ */
.card {
  background: #111;
  border: 2px solid #1e1e1e;
  border-radius: 10px;
  overflow: hidden;
}
.card-title {
  background: #1a1a1a;
  padding: 8px 14px;
  font-size: .65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: #666;
  border-bottom: 1px solid #222;
}

/* Eye / Mouth status blocks */
.status-block {
  padding: 12px 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.status-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}
.status-label { font-size: .75rem; color: #777; }
.status-val {
  font-size: 1.1rem;
  font-weight: 900;
  letter-spacing: .04em;
}
.val-ok   { color: #2ecc71; }
.val-warn { color: #f0b000; }
.val-danger { color: #ff3333; }

.bar-wrap {
  height: 6px;
  background: #1e1e1e;
  border-radius: 3px;
  overflow: hidden;
  margin-top: 2px;
}
.bar {
  height: 100%;
  border-radius: 3px;
  transition: width .2s, background .3s;
}

/* Stats */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1px;
  background: #1e1e1e;
}
.stat-cell {
  background: #111;
  padding: 12px 6px;
  text-align: center;
}
.stat-num {
  font-size: 1.8rem;
  font-weight: 900;
  line-height: 1;
  color: #f0b000;
}
.stat-label { font-size: .6rem; color: #666; margin-top: 3px; text-transform: uppercase; }

/* Head angle */
.angle-block { padding: 12px 14px; display: flex; flex-direction: column; gap: 8px; }
.angle-row { display: flex; justify-content: space-between; align-items: center; }
.angle-label { font-size: .72rem; color: #666; }
.angle-val { font-size: 1.1rem; font-weight: 900; }

.gauge {
  position: relative;
  height: 10px;
  background: #1e1e1e;
  border-radius: 5px;
  overflow: visible;
}
.gauge-safe {
  position: absolute;
  top: 0; bottom: 0;
  left: 33%; width: 34%;
  background: rgba(46,204,113,.2);
  border-radius: 5px;
}
.gauge-cursor {
  position: absolute;
  top: -4px;
  width: 18px; height: 18px;
  border-radius: 50%;
  transform: translateX(-50%);
  transition: left .15s, background .3s;
  left: 50%;
  border: 3px solid #000;
}

/* Log */
.log-body {
  padding: 8px 12px;
  max-height: 130px;
  overflow-y: auto;
  display: flex; flex-direction: column; gap: 3px;
}
.log-body::-webkit-scrollbar { width: 3px; }
.log-body::-webkit-scrollbar-thumb { background: #333; }
.log-entry {
  font-size: .62rem;
  color: #555;
  padding: 2px 6px;
  border-left: 2px solid #222;
  line-height: 1.4;
}
.log-entry.info   { color: #4a9eff; border-color: #4a9eff; }
.log-entry.warn   { color: #f0b000; border-color: #f0b000; }
.log-entry.danger { color: #ff3333; border-color: #ff3333; }

/* Responsive */
@media (max-width: 720px) {
  .main { grid-template-columns: 1fr; }
  .right { display: grid; grid-template-columns: 1fr 1fr; }
}
@media (max-width: 480px) {
  .right { grid-template-columns: 1fr; }
  .main { padding: 8px; gap: 8px; }
  header { padding: 10px 12px; }
  .logo { font-size: 1.3rem; }
}
</style>
</head>
<body>

<header>
  <div class="logo">DRIVE<span>SAFE</span></div>
  <div class="authors">
    <strong>L·∫°i Th·ªã Th·∫£o Quy√™n ¬∑ Ho√†ng ƒê√¨nh Qu·ªëc ƒêo√†n ¬∑ T·ª´ Huy Ph√°t</strong>
  </div>
  <div class="clock">
    <span id="clock">--:--:--</span>
    <small id="sysStatus">CH·ªú</small>
  </div>
</header>

<div class="main">

  <!-- Camera -->
  <div class="cam-card">
    <div class="cam-wrap">
      <video id="videoEl" playsinline autoplay muted></video>
      <canvas id="canvasEl"></canvas>
      <div class="fps-tag" id="fpsLabel">0 FPS</div>
      <div class="cam-placeholder" id="camPlaceholder">
        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.2">
          <path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/>
        </svg>
        <p>Nh·∫•n <strong style="color:#f0b000">B·∫ÆT ƒê·∫¶U</strong> ƒë·ªÉ<br>k√≠ch ho·∫°t camera</p>
      </div>
    </div>

    <div class="err-box" id="errBox"></div>

    <div class="alert-banner safe" id="alertBanner">
      <div class="alert-dot"></div>
      <span id="alertText">H·ªÜ TH·ªêNG S·∫¥N S√ÄNG</span>
    </div>

    <div class="btns">
      <button class="btn btn-start" id="btnStart" onclick="startMonitor()">‚ñ∂ B·∫ÆT ƒê·∫¶U GI√ÅM S√ÅT</button>
      <button class="btn btn-stop"  id="btnStop"  onclick="stopMonitor()" disabled>‚ñ† D·ª™NG</button>
    </div>
  </div>

  <!-- Right -->
  <div class="right">

    <!-- M·∫Øt & Mi·ªáng -->
    <div class="card">
      <div class="card-title">Tr·∫°ng th√°i khu√¥n m·∫∑t</div>
      <div class="status-block">
        <div>
          <div class="status-row">
            <span class="status-label">üëÅ M·∫ÆT</span>
            <span class="status-val val-ok" id="eyeStatus">M·ªû</span>
          </div>
          <div class="bar-wrap"><div class="bar" id="earBar" style="width:0%"></div></div>
          <div style="font-size:.62rem;color:#444;margin-top:3px">EAR: <span id="earValue">‚Äî</span></div>
        </div>
        <div>
          <div class="status-row">
            <span class="status-label">üòÆ MI·ªÜNG</span>
            <span class="status-val val-ok" id="mouthStatus">B√åNH TH∆Ø·ªúNG</span>
          </div>
          <div class="bar-wrap"><div class="bar" id="marBar" style="width:0%;background:#4a9eff"></div></div>
          <div style="font-size:.62rem;color:#444;margin-top:3px">MAR: <span id="marValue">‚Äî</span></div>
        </div>
      </div>
    </div>

    <!-- H∆∞·ªõng nh√¨n -->
    <div class="card">
      <div class="card-title">H∆∞·ªõng nh√¨n</div>
      <div class="angle-block">
        <div class="angle-row">
          <span class="angle-label">‚Üî Ngang (Yaw)</span>
          <span class="angle-val" id="yawValue" style="color:#f0b000">0¬∞</span>
        </div>
        <div class="gauge">
          <div class="gauge-safe"></div>
          <div class="gauge-cursor" id="gaugeCursor" style="background:#2ecc71;left:50%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:.58rem;color:#444;margin-top:2px">
          <span>‚Üê 60¬∞</span><span>TRUNG T√ÇM</span><span>60¬∞ ‚Üí</span>
        </div>
        <div class="angle-row" style="margin-top:4px">
          <span class="angle-label">‚Üï D·ªçc (Pitch)</span>
          <span class="angle-val" id="pitchValue" style="color:#f0b000">0¬∞</span>
        </div>
        <div class="angle-row">
          <span class="angle-label">Tr·∫°ng th√°i</span>
          <span class="status-val val-ok" id="poseStatus">TH·∫≤NG</span>
        </div>
      </div>
    </div>

    <!-- Th·ªëng k√™ -->
    <div class="card">
      <div class="card-title">Th·ªëng k√™ chuy·∫øn ƒëi</div>
      <div class="stats-grid">
        <div class="stat-cell">
          <div class="stat-num" id="statDrowsy" style="color:#ff3333">0</div>
          <div class="stat-label">Bu·ªìn ng·ªß</div>
        </div>
        <div class="stat-cell">
          <div class="stat-num" id="statYawn" style="color:#f0b000">0</div>
          <div class="stat-label">Ng√°p</div>
        </div>
        <div class="stat-cell">
          <div class="stat-num" id="statDistract" style="color:#4a9eff">0</div>
          <div class="stat-label">L∆° ƒë√£ng</div>
        </div>
      </div>
    </div>

    <!-- Nh·∫≠t k√Ω -->
    <div class="card">
      <div class="card-title">Nh·∫≠t k√Ω s·ª± ki·ªán</div>
      <div class="log-body" id="logBody">
        <div class="log-entry info">H·ªá th·ªëng kh·ªüi ƒë·ªông</div>
      </div>
    </div>

  </div>
</div>

<script>
// ================================================================
// CONFIG
// ================================================================
const EAR_THRESHOLD   = 0.20;
const EAR_CONSEC_SEC  = 2.0;
const MAR_THRESHOLD   = 0.55;
const MAR_CONSEC_SEC  = 1.5;
const YAW_THRESHOLD   = 30;
const PITCH_THRESHOLD = 25;
const POSE_CONSEC_SEC = 3.0;

// ================================================================
// State
// ================================================================
let isRunning=false, faceMesh=null, animId=null, ctx2d=null;
let earClosedStart=null, marOpenStart=null, poseAbnStart=null;
let lastFpsTime=performance.now(), frameCount=0;
let stats={drowsy:0,yawn:0,distract:0};
let alertCooldown={};
let mediapipeReady=false;

// ================================================================
// Script loader
// ================================================================
function loadScript(src) {
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src=src; s.crossOrigin='anonymous';
    s.onload=res; s.onerror=()=>rej(new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c: '+src));
    document.head.appendChild(s);
  });
}

// ================================================================
// Audio
// ================================================================
let audioCtx=null;
function getAC(){ if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); return audioCtx; }

function beep(freq=880,dur=0.3,vol=1.0,type='sine'){
  try{
    const ac=getAC(), o=ac.createOscillator(), g=ac.createGain();
    const comp=ac.createDynamicsCompressor();
    comp.threshold.value=-6; comp.knee.value=3; comp.ratio.value=20;
    comp.attack.value=0; comp.release.value=0.1;
    o.connect(g); g.connect(comp); comp.connect(ac.destination);
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(vol,ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+dur);
    o.start(); o.stop(ac.currentTime+dur);
  }catch(e){}
}

function alertSound(type){
  const now=Date.now();
  if(alertCooldown[type]&&now-alertCooldown[type]<4000) return;
  alertCooldown[type]=now;
  if(type==='drowsy'){
    [0,400,800].forEach(d=>setTimeout(()=>{ beep(960,.35,1.2,'sawtooth'); setTimeout(()=>beep(660,.25,1.0,'square'),200); },d));
  }
  if(type==='yawn'){ beep(700,.4,.9,'sine'); setTimeout(()=>beep(700,.4,.9,'sine'),500); }
  if(type==='distract'){ [0,180,360].forEach(d=>setTimeout(()=>beep(1100,.15,1.0,'square'),d)); }
}

// ================================================================
// Geometry
// ================================================================
function d2(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }
function calcEAR(lm,idx){ const p=idx.map(i=>lm[i]); return (d2(p[1],p[5])+d2(p[2],p[4]))/(2*d2(p[0],p[3])); }
function calcMAR(lm){ return d2(lm[13],lm[14])/d2(lm[78],lm[308]); }
function calcPose(lm){
  const le=lm[33],re=lm[263],n=lm[1],fh=lm[10],ch=lm[152];
  const cx=(le.x+re.x)/2, ew=d2(le,re);
  const yaw=Math.atan2(n.x-cx,ew*.5)*(180/Math.PI)*2.5;
  const fhh=d2(fh,ch), midY=(fh.y+ch.y)/2;
  const pitch=-((n.y-midY)/(fhh*.3))*30;
  return { yaw:Math.max(-60,Math.min(60,yaw)), pitch:Math.max(-45,Math.min(45,pitch)) };
}
const LE=[33,160,158,133,153,144], RE=[362,385,387,263,373,380];

// ================================================================
// UI
// ================================================================
function setAlert(level,text){
  const b=document.getElementById('alertBanner');
  b.className='alert-banner '+level;
  document.getElementById('alertText').textContent=text;
  const s=document.getElementById('sysStatus');
  s.textContent={safe:'AN TO√ÄN',warn:'C·∫¢NH B√ÅO',danger:'NGUY HI·ªÇM'}[level]||level;
  s.style.color={safe:'#2ecc71',warn:'#f0b000',danger:'#ff3333'}[level]||'#666';
}
function setErr(msg){
  const b=document.getElementById('errBox');
  b.style.display=msg?'block':'none'; b.textContent=msg?'‚ö† '+msg:'';
}
function addLog(text,type=''){
  const now=new Date().toLocaleTimeString('vi-VN');
  const body=document.getElementById('logBody');
  const d=document.createElement('div');
  d.className='log-entry '+type; d.textContent=`[${now}] ${text}`;
  body.prepend(d);
  while(body.children.length>60) body.removeChild(body.lastChild);
}

function updateEye(v){
  document.getElementById('earValue').textContent=v.toFixed(3);
  const pct=Math.min(100,v*250);
  const bar=document.getElementById('earBar');
  bar.style.width=pct+'%';
  bar.style.background=v<EAR_THRESHOLD?'#ff3333':'#2ecc71';
  const el=document.getElementById('eyeStatus');
  el.textContent=v<EAR_THRESHOLD?'NH·∫ÆM':'M·ªû';
  el.className='status-val '+(v<EAR_THRESHOLD?'val-danger':'val-ok');
}
function updateMouth(v){
  document.getElementById('marValue').textContent=v.toFixed(3);
  const bar=document.getElementById('marBar');
  bar.style.width=Math.min(100,v*100)+'%';
  bar.style.background=v>MAR_THRESHOLD?'#f0b000':'#4a9eff';
  const el=document.getElementById('mouthStatus');
  el.textContent=v>MAR_THRESHOLD?'NG√ÅP!':'B√åNH TH∆Ø·ªúNG';
  el.className='status-val '+(v>MAR_THRESHOLD?'val-warn':'val-ok');
}
function updatePose(yaw,pitch){
  document.getElementById('yawValue').textContent=yaw.toFixed(1)+'¬∞';
  document.getElementById('pitchValue').textContent=pitch.toFixed(1)+'¬∞';
  const pct=((yaw+60)/120)*100;
  const cur=document.getElementById('gaugeCursor');
  cur.style.left=pct+'%';
  const away=Math.abs(yaw)>YAW_THRESHOLD||pitch>PITCH_THRESHOLD;
  cur.style.background=away?'#ff3333':'#2ecc71';
  const el=document.getElementById('poseStatus');
  el.textContent=away?'L·ªÜCH':'TH·∫≤NG';
  el.className='status-val '+(away?'val-danger':'val-ok');
}

// ================================================================
// Face Mesh callback
// ================================================================
function onResults(results){
  const video=document.getElementById('videoEl');
  const canvas=document.getElementById('canvasEl');
  canvas.width=video.videoWidth||640; canvas.height=video.videoHeight||480;
  if(!ctx2d) ctx2d=canvas.getContext('2d');
  ctx2d.clearRect(0,0,canvas.width,canvas.height);

  frameCount++;
  const now=performance.now();
  if(now-lastFpsTime>=1000){ document.getElementById('fpsLabel').textContent=frameCount+' FPS'; frameCount=0; lastFpsTime=now; }

  if(!results.multiFaceLandmarks||!results.multiFaceLandmarks.length){
    setAlert('warn','KH√îNG PH√ÅT HI·ªÜN KHU√îN M·∫∂T');
    return;
  }

  const lm=results.multiFaceLandmarks[0];
  const W=canvas.width, H=canvas.height;
  const px=l=>({x:l.x*W,y:l.y*H});
  const slm=lm.map(px);

  // V·∫Ω vi·ªÅn m·∫Øt & mi·ªáng
  function drawLoop(idxArr,color,lw=1.5){
    ctx2d.strokeStyle=color; ctx2d.lineWidth=lw; ctx2d.beginPath();
    idxArr.forEach((i,j)=>{ const p=slm[i]; j===0?ctx2d.moveTo(p.x,p.y):ctx2d.lineTo(p.x,p.y); });
    ctx2d.closePath(); ctx2d.stroke();
  }
  drawLoop(LE,'rgba(46,204,113,.9)');
  drawLoop(RE,'rgba(46,204,113,.9)');
  drawLoop([78,95,88,178,87,14,317,402,318,308,415,310,311,312,13,82,81,80,191],'rgba(240,176,0,.7)');

  // Ch·ªâ s·ªë
  const earVal=(calcEAR(slm,LE)+calcEAR(slm,RE))/2;
  const marVal=calcMAR(slm);
  const {yaw,pitch}=calcPose(lm);

  updateEye(earVal); updateMouth(marVal); updatePose(yaw,pitch);

  const ts=performance.now()/1000;
  let level='safe', msg='AN TO√ÄN ‚Äî ƒêANG THEO D√ïI';
  let nD=false,nY=false,nDist=false;

  // Bu·ªìn ng·ªß
  if(earVal<EAR_THRESHOLD){
    if(!earClosedStart) earClosedStart=ts;
    const el=ts-earClosedStart;
    if(el>=EAR_CONSEC_SEC){ level='danger'; msg='‚ö† BU·ªíN NG·ª¶! H√ÉY D·ª™NG XE NGAY!'; nD=true; alertSound('drowsy'); }
    else if(el>=1){ level='warn'; msg='M·∫ÆT ƒêANG NH·∫ÆM ‚Äî CH√ö √ù!'; }
  } else earClosedStart=null;

  // Ng√°p
  if(marVal>MAR_THRESHOLD){
    if(!marOpenStart) marOpenStart=ts;
    if(ts-marOpenStart>=MAR_CONSEC_SEC){
      if(level!=='danger') level='warn';
      msg='PH√ÅT HI·ªÜN NG√ÅP ‚Äî N√äN NGH·ªà NG∆†I!'; nY=true; alertSound('yawn');
    }
  } else marOpenStart=null;

  // M·∫•t t·∫≠p trung
  const poseAbn=Math.abs(yaw)>YAW_THRESHOLD||pitch>PITCH_THRESHOLD;
  if(poseAbn){
    if(!poseAbnStart) poseAbnStart=ts;
    const el=ts-poseAbnStart;
    const reason=pitch>PITCH_THRESHOLD?'NH√åN XU·ªêNG':(yaw>0?'NH√åN SANG PH·∫¢I':'NH√åN SANG TR√ÅI');
    if(el>=POSE_CONSEC_SEC){ if(level!=='danger') level='warn'; msg='‚ö† M·∫§T T·∫¨P TRUNG ‚Äî '+reason; nDist=true; alertSound('distract'); }
    else if(el>=1.5&&level==='safe') msg='CH√ö √ù ‚Äî '+reason;
  } else poseAbnStart=null;

  setAlert(level,msg);

  if(nD){ stats.drowsy++; document.getElementById('statDrowsy').textContent=stats.drowsy; addLog('BU·ªíN NG·ª¶ ph√°t hi·ªán','danger'); }
  if(nY){ stats.yawn++;   document.getElementById('statYawn').textContent=stats.yawn;     addLog('NG√ÅP ph√°t hi·ªán','warn'); }
  if(nDist){ stats.distract++; document.getElementById('statDistract').textContent=stats.distract; addLog('M·∫§T T·∫¨P TRUNG: '+(pitch>PITCH_THRESHOLD?'C√∫i ƒë·∫ßu':(yaw>0?'Ph·∫£i':'Tr√°i')),'warn'); }

  // Ch·∫•m m≈©i
  const nose=slm[1];
  ctx2d.fillStyle=poseAbn?'#ff3333':'#f0b000';
  ctx2d.beginPath(); ctx2d.arc(nose.x,nose.y,5,0,Math.PI*2); ctx2d.fill();
}

// ================================================================
// Start / Stop
// ================================================================
async function startMonitor(){
  document.getElementById('btnStart').disabled=true;
  document.getElementById('btnStop').disabled=false;
  setErr('');
  setAlert('safe','ƒêANG KH·ªûI ƒê·ªòNG...');
  addLog('ƒêang m·ªü camera...','info');

  try{
    getAC();
    const stream=await navigator.mediaDevices.getUserMedia({ video:{width:{ideal:640},height:{ideal:480},facingMode:'user'}, audio:false });
    const video=document.getElementById('videoEl');
    video.srcObject=stream;
    await video.play();
    document.getElementById('camPlaceholder').style.display='none';
    addLog('Camera ƒë√£ m·ªü','info');

    if(!mediapipeReady){
      setAlert('safe','ƒêANG T·∫¢I M√î H√åNH AI...');
      addLog('ƒêang t·∫£i MediaPipe...','info');
      await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js');
      await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js');
      mediapipeReady=true;
      addLog('M√¥ h√¨nh AI s·∫µn s√†ng','info');
    }

    faceMesh=new FaceMesh({ locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${f}` });
    faceMesh.setOptions({ maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:.5, minTrackingConfidence:.5 });
    faceMesh.onResults(onResults);

    isRunning=true;
    const video2=document.getElementById('videoEl');
    async function loop(){ if(!isRunning)return; await faceMesh.send({image:video2}); animId=requestAnimationFrame(loop); }
    loop();

    setAlert('safe','AN TO√ÄN ‚Äî ƒêANG THEO D√ïI');
    document.getElementById('sysStatus').textContent='ƒêANG CH·∫†Y';
    document.getElementById('sysStatus').style.color='#2ecc71';
    addLog('Gi√°m s√°t b·∫Øt ƒë·∫ßu','info');

  }catch(err){
    console.error(err);
    document.getElementById('btnStart').disabled=false;
    document.getElementById('btnStop').disabled=true;
    document.getElementById('camPlaceholder').style.display='flex';
    let msg='L·ªói: '+err.message;
    if(err.name==='NotAllowedError') msg='Quy·ªÅn camera b·ªã t·ª´ ch·ªëi. Vui l√≤ng cho ph√©p trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.';
    else if(err.name==='NotFoundError') msg='Kh√¥ng t√¨m th·∫•y camera. Ki·ªÉm tra thi·∫øt b·ªã.';
    else if(err.name==='NotReadableError') msg='Camera ƒëang ƒë∆∞·ª£c d√πng b·ªüi ·ª©ng d·ª•ng kh√°c.';
    setErr(msg); setAlert('warn','L·ªñI KH·ªûI ƒê·ªòNG'); addLog(msg,'warn');
  }
}

function stopMonitor(){
  isRunning=false;
  if(animId){ cancelAnimationFrame(animId); animId=null; }
  const video=document.getElementById('videoEl');
  if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
  faceMesh=null;
  const canvas=document.getElementById('canvasEl');
  if(ctx2d) ctx2d.clearRect(0,0,canvas.width,canvas.height);
  document.getElementById('camPlaceholder').style.display='flex';
  document.getElementById('btnStart').disabled=false;
  document.getElementById('btnStop').disabled=true;
  setAlert('safe','ƒê√É D·ª™NG GI√ÅM S√ÅT');
  document.getElementById('sysStatus').textContent='CH·ªú';
  document.getElementById('sysStatus').style.color='#666';
  addLog(`D·ª´ng ‚Äî Bu·ªìn ng·ªß:${stats.drowsy} Ng√°p:${stats.yawn} L∆° ƒë√£ng:${stats.distract}`,'info');
  earClosedStart=marOpenStart=poseAbnStart=null;
}

// Clock
setInterval(()=>document.getElementById('clock').textContent=new Date().toLocaleTimeString('vi-VN'),1000);
document.getElementById('clock').textContent=new Date().toLocaleTimeString('vi-VN');
</script>
</body>
</html>
