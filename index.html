<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DriveSafe — Hệ thống giám sát lái xe AI</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Exo+2:wght@300;400;600&display=swap');
  :root {
    --bg:#020c14;--panel:#071828;--border:#0a3d62;
    --accent:#00d4ff;--accent2:#00ff88;--warn:#ff6b35;--danger:#ff1744;
    --text:#c8e6f5;--dim:#3a6d8a;--grid:rgba(0,212,255,0.04);
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:'Exo 2',sans-serif;min-height:100vh;overflow-x:hidden}
  body::before{content:'';position:fixed;inset:0;
    background-image:linear-gradient(var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);
    background-size:40px 40px;pointer-events:none;z-index:0}
  header{position:relative;z-index:10;padding:16px 28px;display:flex;align-items:center;justify-content:space-between;
    border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(0,212,255,0.06) 0%,transparent 100%)}
  .logo{font-family:'Orbitron',monospace;font-size:1.4rem;font-weight:900;color:var(--accent);letter-spacing:.15em;text-shadow:0 0 20px rgba(0,212,255,0.5)}
  .logo span{color:var(--accent2)}
  .header-status{font-family:'Share Tech Mono',monospace;font-size:.7rem;color:var(--dim);text-align:right;line-height:1.8}
  .main{position:relative;z-index:1;display:grid;grid-template-columns:1fr 320px;gap:16px;padding:16px 20px;max-width:1300px;margin:0 auto}
  .camera-panel{background:var(--panel);border:1px solid var(--border);border-radius:4px;overflow:hidden}
  .camera-wrap{position:relative;aspect-ratio:4/3;background:#000;overflow:hidden}
  #videoEl{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);display:block}
  #canvasEl{position:absolute;inset:0;width:100%;height:100%;transform:scaleX(-1);pointer-events:none}
  .cam-overlay{position:absolute;inset:0;pointer-events:none;border:2px solid var(--accent);box-shadow:inset 0 0 40px rgba(0,212,255,0.1)}
  .cam-overlay::before{content:'';position:absolute;top:-1px;left:-1px;width:20px;height:20px;border-top:3px solid var(--accent);border-left:3px solid var(--accent)}
  .cam-overlay::after{content:'';position:absolute;bottom:-1px;right:-1px;width:20px;height:20px;border-bottom:3px solid var(--accent);border-right:3px solid var(--accent)}
  .scan-line{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(0,212,255,0.6),transparent);animation:scan 3s linear infinite;pointer-events:none}
  @keyframes scan{0%{top:0;opacity:1}100%{top:100%;opacity:0}}
  .cam-label{position:absolute;top:10px;left:10px;font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--accent);background:rgba(2,12,20,0.85);padding:3px 8px;border:1px solid rgba(0,212,255,0.3)}
  .fps-label{position:absolute;top:10px;right:10px;font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);background:rgba(2,12,20,0.85);padding:3px 8px;border:1px solid var(--border)}
  .cam-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;background:rgba(2,12,20,0.95)}
  .cam-placeholder p{font-family:'Share Tech Mono',monospace;font-size:.7rem;color:var(--dim);text-align:center;line-height:1.7}
  .alert-banner{padding:0 20px;min-height:50px;display:flex;align-items:center;justify-content:center;gap:10px;
    font-family:'Orbitron',monospace;font-size:.8rem;letter-spacing:.1em;font-weight:700;transition:all .3s;border-top:1px solid var(--border)}
  .alert-banner.safe{color:var(--accent2);background:rgba(0,255,136,0.05)}
  .alert-banner.warn{color:var(--warn);background:rgba(255,107,53,0.08);animation:pw 1s infinite}
  .alert-banner.danger{color:var(--danger);background:rgba(255,23,68,0.1);animation:pd .5s infinite}
  @keyframes pw{0%,100%{opacity:1}50%{opacity:.6}}
  @keyframes pd{0%,100%{opacity:1}50%{opacity:.4}}
  .alert-dot{width:9px;height:9px;border-radius:50%;background:currentColor;box-shadow:0 0 8px currentColor}
  .controls{display:flex;gap:10px;padding:14px 16px;border-top:1px solid var(--border)}
  .btn{flex:1;padding:11px 16px;font-family:'Orbitron',monospace;font-size:.7rem;font-weight:700;letter-spacing:.1em;border:none;cursor:pointer;text-transform:uppercase;transition:all .2s;clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%)}
  .btn-start{background:linear-gradient(135deg,#004d40,#00897b);color:#a7ffeb;box-shadow:0 0 20px rgba(0,137,123,.3)}
  .btn-stop{background:linear-gradient(135deg,#4a0000,#b71c1c);color:#ffcdd2;box-shadow:0 0 20px rgba(183,28,28,.3)}
  .right-panel{display:flex;flex-direction:column;gap:12px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:4px;overflow:hidden}
  .card-header{padding:9px 14px;background:rgba(0,212,255,0.04);border-bottom:1px solid var(--border);
    font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);letter-spacing:.15em;text-transform:uppercase;display:flex;align-items:center;gap:6px}
  .metrics{padding:10px 14px;display:flex;flex-direction:column;gap:9px}
  .metric-label{font-size:.7rem;color:var(--dim);font-family:'Share Tech Mono',monospace}
  .metric-value{font-family:'Orbitron',monospace;font-size:.8rem;font-weight:700}
  .bar-wrap{width:100%;margin-top:4px;height:3px;background:rgba(0,212,255,0.1);border-radius:2px;overflow:hidden}
  .bar{height:100%;border-radius:2px;transition:width .2s,background .3s;background:var(--accent2)}
  .badge{font-family:'Share Tech Mono',monospace;font-size:.65rem;padding:2px 8px;border-radius:2px;letter-spacing:.06em}
  .badge.open{background:rgba(0,255,136,0.15);color:var(--accent2);border:1px solid rgba(0,255,136,0.3)}
  .badge.closed{background:rgba(255,107,53,0.15);color:var(--warn);border:1px solid rgba(255,107,53,0.3)}
  .gauge-section{padding:12px 14px 14px}
  .gauge-track{width:100%;height:7px;background:rgba(0,212,255,0.08);border-radius:4px;position:relative;margin-bottom:4px}
  .gauge-cursor{position:absolute;top:-5px;width:16px;height:16px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent);transform:translateX(-50%);left:50%}
  .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border)}
  .stat-cell{background:var(--panel);padding:10px 8px;text-align:center}
  .stat-num{font-family:'Orbitron',monospace;font-size:1.3rem;font-weight:900;color:var(--accent);line-height:1}
  .stat-label{font-family:'Share Tech Mono',monospace;font-size:.5rem;color:var(--dim);margin-top:3px;text-transform:uppercase}
  .log-body{padding:8px 14px;max-height:140px;overflow-y:auto;display:flex;flex-direction:column;gap:3px}
  .log-entry{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);padding:2px 7px;border-left:2px solid var(--border);line-height:1.4}
  .err-box{margin:12px 16px;padding:10px 14px;background:rgba(255,23,68,0.08);border:1px solid rgba(255,23,68,0.3);border-radius:3px;font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--danger);line-height:1.6;display:none}
  @media(max-width:860px){.main{grid-template-columns:1fr}.right-panel{display:grid;grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.right-panel{grid-template-columns:1fr}.main{padding:10px}}
</style>
</head>
<body>

<header>
  <div class="logo">DRIVE<span>SAFE</span></div>
  <div class="header-status">
    <div id="sysTime">--:--:--</div>
    <div id="sysStatus" style="color:var(--dim)">CHỜ</div>
  </div>
</header>

<div class="main">
  <div class="camera-panel">
    <div class="camera-wrap">
      <video id="videoEl" playsinline autoplay muted></video>
      <canvas id="canvasEl"></canvas>
      <div class="cam-overlay"><div class="scan-line"></div></div>
      <div class="cam-label">CAM-01 // AI GIÁM SÁT</div>
      <div class="fps-label" id="fpsLabel">0 FPS</div>
      <div class="cam-placeholder" id="camPlaceholder">
        <p>Nhấn <strong style="color:var(--accent)">BẮT ĐẦU</strong> để kích hoạt camera</p>
      </div>
    </div>
    <div class="err-box" id="errBox"></div>
    <div class="alert-banner safe" id="alertBanner">
      <div class="alert-dot"></div>
      <span id="alertText">HỆ THỐNG SẴN SÀNG</span>
    </div>
    <div class="controls">
      <button class="btn btn-start" id="btnStart" onclick="startMonitor()">▶ BẮT ĐẦU GIÁM SÁT</button>
      <button class="btn btn-stop"  id="btnStop"  onclick="stopMonitor()" disabled>■ DỪNG</button>
    </div>
  </div>

  <div class="right-panel">
    <div class="card">
      <div class="card-header">Khuôn mặt</div>
      <div class="metrics">
        <div>
          <div style="display:flex;justify-content:space-between">
            <span class="metric-label">MẮT</span>
            <span class="badge open" id="eyeStatus">MỞ</span>
          </div>
          <div class="bar-wrap"><div class="bar" id="earBar" style="width:0%"></div></div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between">
            <span class="metric-label">MIỆNG</span>
            <span class="badge" id="mouthStatus">BÌNH THƯỜNG</span>
          </div>
          <div class="bar-wrap"><div class="bar" id="marBar" style="width:0%;background:var(--accent)"></div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Hướng nhìn</div>
      <div class="gauge-section">
        <div class="gauge-track"><div class="gauge-cursor" id="gaugeCursor"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:10px">
          <span class="metric-label">GÓC NGANG</span>
          <span class="metric-value" id="yawValue">0°</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Thống kê</div>
      <div class="stats-grid">
        <div class="stat-cell"><div class="stat-num" id="statDrowsy">0</div><div class="stat-label">Ngủ gật</div></div>
        <div class="stat-cell"><div class="stat-num" id="statYawn">0</div><div class="stat-label">Ngáp</div></div>
        <div class="stat-cell"><div class="stat-num" id="statDistract">0</div><div class="stat-label">Lơ đãng</div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Nhật ký</div>
      <div class="log-body" id="logBody">
        <div class="log-entry">HỆ THỐNG KHỞI ĐỘNG</div>
      </div>
    </div>
  </div>
</div>

<script>
// Logic âm thanh báo động liên tục cho điện thoại & máy tính
let audioCtx = null;
let alertInterval = null;
const alertCooldown = {};

function getAC() { 
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx; 
}

function playEmergencyAlarm() {
  if (alertInterval) return;
  const ac = getAC();
  alertInterval = setInterval(() => {
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.connect(g); g.connect(ac.destination);
    o.type = 'sawtooth';
    o.frequency.setValueAtTime(880, ac.currentTime);
    o.frequency.exponentialRampToValueAtTime(440, ac.currentTime + 0.15);
    g.gain.setValueAtTime(0.6, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + 0.15);
    o.start(); o.stop(ac.currentTime + 0.15);
  }, 250); 
}

function stopEmergencyAlarm() {
  if (alertInterval) { clearInterval(alertInterval); alertInterval = null; }
}

function beep(freq=880, dur=0.3, vol=0.4, type='sine') {
  try {
    const ac=getAC(), o=ac.createOscillator(), g=ac.createGain();
    o.connect(g); g.connect(ac.destination);
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(vol,ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+dur);
    o.start(); o.stop(ac.currentTime+dur);
  } catch(e){}
}

function alertSound(type) {
  const now = Date.now();
  if (type === 'drowsy') {
    playEmergencyAlarm();
  } else {
    if (alertCooldown[type] && now - alertCooldown[type] < 3000) return;
    alertCooldown[type] = now;
    if (type === 'yawn') beep(600, 0.5, 0.3, 'sine');
    if (type === 'distract') beep(880, 0.2, 0.4, 'square');
  }
}

// MediaPipe & Thuật toán
const EAR_THRESHOLD = 0.20;
const EAR_CONSEC_SEC = 1.5;
const MAR_THRESHOLD = 0.55;
const YAW_THRESHOLD = 30;

let isRunning = false, faceMesh = null, ctx2d = null;
let earClosedStart = null, lastFpsTime = performance.now(), frameCount = 0;
let stats = { drowsy:0, yawn:0, distract:0 };
let mediapipeReady = false;

function loadScript(src) {
  return new Promise((res, rej) => {
    const s = document.createElement('script');
    s.src = src; s.crossOrigin = 'anonymous';
    s.onload = res; s.onerror = rej;
    document.head.appendChild(s);
  });
}

function d2(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }
function ear(lm,idx) {
  const p=idx.map(i=>lm[i]);
  return (d2(p[1],p[5])+d2(p[2],p[4]))/(2*d2(p[0],p[3]));
}

function onResults(results) {
  const video=document.getElementById('videoEl');
  const canvas=document.getElementById('canvasEl');
  if(!ctx2d) ctx2d=canvas.getContext('2d');
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  ctx2d.clearRect(0,0,canvas.width,canvas.height);

  frameCount++;
  const now=performance.now();
  if(now-lastFpsTime>=1000){ document.getElementById('fpsLabel').textContent=frameCount+' FPS'; frameCount=0; lastFpsTime=now; }

  if(!results.multiFaceLandmarks||!results.multiFaceLandmarks.length){
    setAlert('warn','KHÔNG THẤY KHUÔN MẶT');
    stopEmergencyAlarm();
    return;
  }

  const lm=results.multiFaceLandmarks[0];
  const slm=lm.map(l=>({x:l.x*canvas.width,y:l.y*canvas.height}));

  const earVal=(ear(slm,[33,160,158,133,153,144])+ear(slm,[362,385,387,263,373,380]))/2;
  const marVal=d2(slm[13],slm[14])/d2(slm[78],slm[308]);
  const yaw=(lm[1].x-((lm[33].x+lm[263].x)/2))*250;

  // Cập nhật UI
  document.getElementById('earBar').style.width=(earVal*250)+'%';
  document.getElementById('eyeStatus').textContent=earVal<EAR_THRESHOLD?'NHẮM':'MỞ';
  document.getElementById('eyeStatus').className='badge '+(earVal<EAR_THRESHOLD?'closed':'open');
  document.getElementById('marBar').style.width=(marVal*100)+'%';
  document.getElementById('gaugeCursor').style.left=((yaw+60)/120*100)+'%';
  document.getElementById('yawValue').textContent=Math.round(yaw)+'°';

  const ts=performance.now()/1000;
  if(earVal<EAR_THRESHOLD){
    if(!earClosedStart) earClosedStart=ts;
    if(ts-earClosedStart>=EAR_CONSEC_SEC){
      setAlert('danger','⚠ CẢNH BÁO: NGỦ GẬT!');
      alertSound('drowsy');
      stats.drowsy++; document.getElementById('statDrowsy').textContent=Math.floor(stats.drowsy/10); 
    }
  } else {
    earClosedStart=null;
    stopEmergencyAlarm();
    setAlert('safe','AN TOÀN — ĐANG THEO DÕI');
  }

  if(marVal>MAR_THRESHOLD) { alertSound('yawn'); stats.yawn++; document.getElementById('statYawn').textContent=Math.floor(stats.yawn/20); }
  if(Math.abs(yaw)>YAW_THRESHOLD) { alertSound('distract'); stats.distract++; document.getElementById('statDistract').textContent=Math.floor(stats.distract/20); }
}

async function startMonitor() {
  try {
    getAC();
    document.getElementById('btnStart').disabled=true;
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
    document.getElementById('videoEl').srcObject=stream;
    document.getElementById('camPlaceholder').style.display='none';
    
    if(!mediapipeReady){
      await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js');
      await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js');
      mediapipeReady=true;
    }

    faceMesh=new FaceMesh({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${f}`});
    faceMesh.setOptions({maxNumFaces:1,refineLandmarks:true,minDetectionConfidence:0.5});
    faceMesh.onResults(onResults);

    isRunning=true;
    const v=document.getElementById('videoEl');
    async function loop(){ if(!isRunning)return; await faceMesh.send({image:v}); requestAnimationFrame(loop); }
    loop();

    document.getElementById('btnStop').disabled=false;
    document.getElementById('sysStatus').textContent='ĐANG CHẠY';
  } catch(e){ alert("Lỗi camera: " + e.message); }
}

function stopMonitor() {
  isRunning=false; stopEmergencyAlarm();
  const v=document.getElementById('videoEl');
  if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
  document.getElementById('btnStart').disabled=false;
  document.getElementById('btnStop').disabled=true;
  document.getElementById('camPlaceholder').style.display='flex';
}

function setAlert(lv,txt){
  const b=document.getElementById('alertBanner');
  b.className='alert-banner '+lv;
  document.getElementById('alertText').textContent=txt;
}

setInterval(()=>{ document.getElementById('sysTime').textContent=new Date().toLocaleTimeString('vi-VN'); },1000);
</script>
</body>
</html>
